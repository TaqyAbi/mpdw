---
title: "Regresi Peubah Lag"
author: "M.Taqy Abiyu Dzakwan"
date: "2025-09-14"
output: 
  html_document:
    embed-resources: true
    toc: true
    self-contained: true
---
```{r}
knitr::opts_chunk$set(
  warning = FALSE,  # sembunyikan warning
  message = FALSE   # sembunyikan message
)
```

# Panggil Library

```{r}
library(dLagM)
library(dynlm)
library(MLmetrics)
library(lmtest)
library(readr)
library(dplyr)
```

# Import Data

Data yang digunakan berasal dari air quality New Delhi dengan peubah Y yaitu AQI (Air Quality Index) dan peubah X yaitu PM 2,5

```{r}
dt <- read_csv("D:\\TUGAS IPB\\Semester 5\\mpdw\\Pertemuan 4\\NewDelhi_Air_quality.csv")
str(dt)
head(dt)
```

# Splitting Data

```{r}
data <- dt %>%
  rename(
    Yt = AQI,
    Xt = pm25
  )

head(data)
```

```{r}
train<-data[0:57,]
test<-data[58:71,]
train.ts<-ts(train)
test.ts<-ts(test)
data.ts<-ts(data)
```

# Model Koyck

## Pemodelan

```{r}
model.koyck <- koyckDlm(x = train$Xt, y = train$Yt)
summary(model.koyck)
AIC(model.koyck)
BIC(model.koyck)
```

Berdasarkan hasil analisis regresi, diperoleh bahwa peubah $Y_{t-1}$ memiliki nilai p-value < 2e-16, sedangkan peubah $X_t$ memiliki nilai p-value 0.0449. Kedua nilai p-value tersebut lebih kecil dari taraf signifikansi α=0.05. Hal ini menunjukkan bahwa peubah $Y_{t-1}$ maupun peubah $X_t$ *berpengaruh secara signifikan* terhadap $Y_t$ pada taraf 5%.

Adapun model regresi yang terbentuk dapat dituliskan sebagai berikut:

$$
\hat{Y_t}=4,54910-0.56825X_t+ 0.87326Y_{t-1}
$$\

Dengan demikian, dapat disimpulkan bahwa perubahan nilai $Y_t$ dipengaruhi secara signifikan oleh dua faktor. Faktor utama adalah nilai $Y_t$ pada periode sebelumnya ($Y_{t-1}$), yang memiliki pengaruh positif sangat kuat. Selain itu, nilai $X_t$ juga memberikan pengaruh yang signifikan namun dengan arah yang negatif. Artinya, kenaikan nilai $X_t$ justru akan menurunkan nilai $Y_t$, dengan asumsi variabel lain konstan.

## Peramalan

Berikut adalah hasil peramalan y untuk 14 periode kedepan menggunakan model koyck

```{r}
# Forecast dengan model Koyck
fore.koyck <- forecast(model = model.koyck, x=test$Xt, h=14)
fore.koyck

# Hitung MAPE untuk data test
mape.koyck <- MAPE(fore.koyck$forecasts, test$Yt)
mape.koyck

# Akurasi data training (Goodness of Fit)
GoF(model.koyck)
```
Hasil menunjukkan bahwa nilai *MAPE* (Mean Absolute Percentage Error) pada model Koyck tergolong *sangat baik*, yakni sebesar *2.495%*.

# Regression with Distributed Lag

Regresi dengan atribut lag memerlukan suatu parameter q yang disesuaikan dengan banyaknya dan kondisi data. Agar hasil model maksimal, maka dapat ditentukan terlebih dahulu nilai q atau lag yang optimum.

## *Lag* Optimum

```{r}
finiteDLMauto(formula = Yt ~ Xt,
              data = data.frame(train), q.min = 1, q.max = 30,
              model.type = "dlm", error.type = "AIC", trace = FALSE)

```
Berdasarkan output tersebut, lag optimum didapatkan ketika lag=27 (karena 28 sudah infinite). Selanjutnya dilakukan pemodelan untuk lag=27.

### Pakai AIC BIC

```{r}
model.dlm <- dlm(x = train$Xt,y = train$Yt , q = 27)
summary(model.dlm)
```
Dari hasil tersebut tidak ada peubah yang berpengaruh signifikan pada taraf nyata 5%, karena semua nilai p-value (kolom Pr(>|t|)) lebih besar dari 0.05. Adapun model keseluruhan yang terbentuk adalah sebagai berikut:

$$
\hat{Y_t}=55.313-20.955X_t +19.456X_{t-1}−23.554X_{t-2} +24.507X_{t-3} +.... +2.407X_{t-27}
$$\


## Peramalan

Adapun hasil peramalan 14 periode kedepan menggunakan model tersebut adalah sebagai berikut :

```{r}
fore.dlm <- forecast(model = model.dlm, x=test$Xt, h=14) #h nya berdasarkan jumlah data test

(mape.dlm<- MAPE(fore.dlm$forecasts, test$Yt))

GoF(model.dlm)
```

Model tersebut merupakan model yang sangat baik dengan nilai MAPE sebesar 6.8904%.

# Model Autoregressive

Pemodelan Autoregressive membutuhkan dua parameter yaitu p dan q sesuai dengan kondisi data. Agar dihasilkan model yang lebih sesuai, maka dapat langsung menggunakan nilai yang optimum.

## Cari Lag Optimum

```{r}
model.ardl.opt <- ardlBoundOrders(data = data.frame(data), ic = "AIC", 
                                  formula = Yt ~ Xt )

min_p <- sapply(model.ardl.opt$Stat.table, min, na.rm = TRUE) #sapply untuk mengoptimumkan

q_opt=which(min_p==min(min_p, na.rm = TRUE))
p_opt=which(model.ardl.opt$Stat.table[[q_opt]] == 
              min(model.ardl.opt$Stat.table[[q_opt]], na.rm = TRUE))
data.frame("q_optimum" = q_opt, "p_optimum" = p_opt, 
           "AIC"=model.ardl.opt$min.Stat)
```

Dari tabel di atas, dapat terlihat bahwa nilai AIC terendah didapat ketika $p=15$ dan $q=5$, yaitu sebesar `124,7089`. Artinya, model autoregressive optimum didapat ketika $p=15$ dan $q=5$.

## Pemodelan

```{r}
model.ardl <- ardlDlm(formula = Yt ~ Xt, 
                         data = train,p = 15 , q = 5)
summary(model.ardl)
AIC(model.ardl)
BIC(model.ardl)
```
Hasil pemodelan deret waktu menunjukkan bahwa tidak semua peubah berpengaruh signifikan terhadap $Y_t$. Berdasarkan uji t pada taraf nyata 5%, hanya peubah $X_t$ (p-value = 0.0138), $Y_{t-1}$ (p-value = 0.0223), dan $Y_{t-2}$ (p-value = 0.0407) yang signifikan. Sedangkan Intercept dan seluruh variabel lag lainnya tidak berpengaruh signifikan karena memiliki nilai p-value > 0.05.

Model keseluruhan yang diperoleh dapat dituliskan sebagai berikut:

$$
\hat{Y_t}=6.393−9.799X_t+ 12.551X_{t-1}+...+0.576Y_{t-1}+0.584Y_{t-2}+...-0.334Y_{t-5}
$$
Nilai Multiple R-squared sebesar 0.9604 dan Adjusted R-squared sebesar 0.9187 menunjukkan bahwa model yang terbentuk mampu menjelaskan sekitar 91.9% variasi pada data, setelah dilakukan penyesuaian terhadap jumlah peubah yang digunakan dalam model.

## Peramalan

```{r}
fore.ardl <- forecast(model = model.ardl, x=test$Xt, h=14)
fore.ardl
```
Data di atas merupakan hasil peramalan untuk 14 periode ke depan menggunakan Model Autoregressive dengan $p=15$ dan $q=5$

```{r}
mape.ardl <- MAPE(fore.ardl$forecasts, test$Yt)
mape.ardl
#akurasi data training
GoF(model.ardl)
```
Berdasarkan perbandingan akurasi, model regresi ini tergolong overfitted karena terdapat perbedaan performa yang sangat signifikan antara MAPE data latih (*1.207%*) dan MAPE data uji (*28.99%*)

# Pemodelan DLM & ARDL dengan Library dynlm

Pemodelan regresi dengan peubah lag tidak hanya dapat dilakukan dengan fungsi pada packages dLagM , tetapi terdapat packages dynlm yang dapat digunakan. Fungsi dynlm secara umum adalah sebagai berikut.

dynlm(formula, data, subset, weights, na.action, method = “qr”, model = TRUE, x = FALSE, y = FALSE, qr = TRUE, singular.ok = TRUE, contrasts = NULL, offset, start = NULL, end = NULL, …)

Untuk menentukan formula model yang akan digunakan, tersedia fungsi tambahan yang memungkinkan spesifikasi dinamika (melalui d() dan L()) atau pola linier/siklus dengan mudah (melalui trend(), season(), dan harmon()). Semua fungsi formula baru mengharuskan argumennya berupa objek deret waktu (yaitu, “ts” atau “zoo”).

L() : fungsi untuk mengambil nilai lag dari suatu variabel.

L(Xt)= Xt pada periode sebelumnya (lag ke-1).

L(Xt, 2) = Xt pada dua periode sebelumnya (lag ke-2).

```{r}
cons_lm1 <- dynlm(Yt ~ Xt+L(Xt),data = train.ts)

#sama dengan model ardl p=1 q=0
cons_lm2 <- dynlm(Yt ~ Xt+L(Yt),data = train.ts)

#sama dengan ardl p=1 q=1
cons_lm3 <- dynlm(Yt ~ Xt+L(Xt)+L(Yt),data = train.ts)

#sama dengan dlm p=2
cons_lm4 <- dynlm(Yt ~ Xt+L(Xt)+L(Xt,2),data = train.ts)
```

## Ringkasan Model

```{r}
summary(cons_lm1)
summary(cons_lm2)
summary(cons_lm3)
summary(cons_lm4)
```

## SSE

```{r}
deviance(cons_lm1)
deviance(cons_lm2)
deviance(cons_lm3)
deviance(cons_lm4)
```

## Ui encomptest

```{r}
#uji model
if(require("lmtest")) encomptest(cons_lm1, cons_lm2)
```
Model 1: p-value < 2e-16 (< 0.05). Artinya, penambahan peubah lag dari Y (L(Yt)) memberikan peningkatan yang signifikan pada model. Sehingga, Model 1 dianggap tidak memadai.

Model 2: p-value = 0.5748 (> 0.05). Artinya, penambahan peubah lag dari X (L(Xt)) tidak memberikan peningkatan yang signifikan pada model. Sehingga, Model 2 dianggap sudah memadai.

### Uji Autokorelasi Residual

```{r}
dwtest(cons_lm1)
dwtest(cons_lm2)
dwtest(cons_lm3)
dwtest(cons_lm4)
```

### Uji Heterogenitas

1. Jika p-value > 0.05 → tidak ada heteroskedastisitas
2. Jika p-value ≤ 0.05 → ada heteroskedastisitas

```{r}
bptest(cons_lm1)
bptest(cons_lm2)
bptest(cons_lm3)
bptest(cons_lm4)
```


### Uji Normalitas

H0: Residual berdistribusi normal.

H1: Residual tidak berdistribusi normal.

1. Jika p-value > 0.05 → gagal tolak H0 → residual normal.

2. Jika p-value ≤ 0.05 → tolak H0 → residual tidak normal.

```{r}
shapiro.test(residuals(cons_lm1))
shapiro.test(residuals(cons_lm2))
shapiro.test(residuals(cons_lm3))
shapiro.test(residuals(cons_lm4))
```

# Perbandingan Model

```{r}
akurasi <- matrix(c(mape.koyck, mape.dlm, mape.ardl))
row.names(akurasi)<- c("Koyck","DLM","Autoregressive")
colnames(akurasi) <- c("MAPE")
akurasi
```
Berdasarkan nilai MAPE, model paling optimum didapat pada Model Koyck karena memiliki nilai MAPE yang terkecil.

## Plot

```{r}
par(mfrow=c(1,1))  # atur layout grafik tunggal

# plot data aktual
plot(test$Xt, test$Yt, type="b", col="black", ylim=c(10,60))

# tambahkan garis ramalan dari masing-masing model
points(test$Xt, fore.koyck$forecasts, col="red");   lines(test$Xt, fore.koyck$forecasts, col="red")
points(test$Xt, fore.dlm$forecasts, col="blue");    lines(test$Xt, fore.dlm$forecasts, col="blue")
points(test$Xt, fore.ardl$forecasts, col="green");  lines(test$Xt, fore.ardl$forecasts, col="green")

# legenda model
legend("topleft",
       c("Aktual", "Koyck","DLM", "Autoregressive"),
       lty=1, col=c("black","red","blue","green"), cex=0.8)
```
Berdasarkan Gambar, garis biru (DLM) memiliki pola yang paling mendekati data aktual. Dengan demikian, model DLM dengan orde lag yang telah dipilih memberikan performa prediksi terbaik dibandingkan model Koyck dan Autoregressive.

```{r}
length(test$Xt)
length(test$Yt)
length(fore.dlm$forecasts)
```

# Uji Asumsi

## SSE

```{r}
deviance(model.dlm$model)
```

## Autokorelasi

```{r}
dwtest(model.dlm$model)
```

## Heterogenitas

```{r}
bptest(model.dlm$model)
```

## Kenormalan

```{r}
shapiro.test(residuals(model.dlm$model))
```
Berdasarkan uji asumsi tersebut, model DLM menyatakan bahwa semua asumsi sudah terpenuhi karena nilai p yang dihasilkan lebih besar dari 0.05 baik pada tidak adanya autokorelasi, ragam sisaan homogen, bahkan sisan menyebar normal.
